<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link rel="stylesheet" href="css/test-leaflet.css" />
<link rel="stylesheet" href="css/MarkerCluster.css" />
<link rel="stylesheet" href="css/MarkerCluster.Default.css" />
<link rel="stylesheet" href="css/Bootstrap.min.css" />
</head>
<body>
	<div class="container-fluid">
      <div class="row">
        <div class="col-md-4 sidebar">
        	<div class="row-fluid">
	        	<div class="col-sm-12">
	        		<div class="row-fluid header">
	        			<div class="col-sm-11 title">
	        				<img src="img/alstom.png">
	        			</div>
	        			<div class="col-sm-1 settings">
	        				<img src="img/ic-settings-24-px.png">
	        			</div>
	        		</div>
			    </div>
			</div>
			<div class="row-fluid search">
		        <div class="col-sm-12 criteria">
		        	<span>
		        		<img src="img/ic-search-24-px.png">
		        		<input id="id-search" class="search-field" type="text" placeholder="Wagon ID, owner or registry #" autofocus>
		        	</span>
				</div>
			</div>
			<div class="row-fluid filters">
				<div class="col-sm-12">
					<div class="row">
				        <div class="col-sm-12 filter styled-select maintenance">
						    <select id="maintenance-days">
						      <option value="0" selected>Next maintenance</option>
						      <option value="1">Maintenance: 1 - 5 days</option>
						      <option value="6">Maintenance: 6 - 19 days</option>
						      <option value="20">Maintenance: 20 - 49 days</option>
						      <option value="50">Maintenance: 50 - 99 days</option>
						      <option value="100">Maintenance: 100+ days</option>
						    </select>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12 filter styled-select">
				        	<select>
				        		<option value="0" selected>Delivery delay</option>
				        	</select>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12 filter styled-select">
				        	<select>
				        		<option value="" selected>Product class</option>
				        		<option value="Hydrogen" selected>Product: Hydrogen</option>
				        		<option value="Oil">Product: Oil</option>
				        		<option value="Coal">Product: Coal</option>
				        	</select>
						</div>
					</div>
				</div>
			</div>
			<div class="row-fluid">
				<div class="col-sm-12">
					<div id="empty-space" class="empty-space">
						<img src="img/group-3.png">
					</div>
					<div id="list-space" class="row-fluid list-space">
				        <div class="col-sm-12" id="list-elements">
				        	<!--div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-green.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-orange.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-green.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-green.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-red.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-green.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div>
				        	<div class="row-fluid list-element">
				        		<div class="col-sm-2 element-badge">
				        			<img src="img/train-with-badge-green.png" class="train-logo">
				        		</div>
				        		<div class="col-sm-10">
				        			<div class="row-fluid element-id">
				        				57 22 1234 5678-9
				        			</div>
				        			<div class="row-fluid short-description">
				        				Hydrogen (57) - Maintenance in 55 days
				        			</div>
				        		</div>
				        	</div-->
				        </div>
				    </div>
				</div>
			</div>
	    </div>
        <div class="col-md-8 main">
        	<div id="mapid"></div>
        </div>
       </div>
    </div>
</body>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="js/leaflet.markercluster-src.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="json/test.json"></script>
<script>

    //var wagons = [ [50.773775, 4.617623], [50.618936, 5.037850], [50.733809, 3.801888], [50.941950, 3.348702], [51.079332, 4.592904] ];

    var wagons = [ [50.845635, 4.357092], [50.845635, 4.357092], [50.845635, 4.357092], [50.845635, 4.357092], [50.845635, 4.357092] ];

    var maintenanceWagon = [51.255651, 4.396658];

    var itineraries = [ [ [50.845635, 4.357092], [50.835797, 4.335732], [50.893041, 4.067648], [50.948967, 4.027103], [51.014405, 3.775365], [51.051021, 3.708190], [51.096047, 3.428722], [51.219193, 3.224506] ], 
    					[ [50.845635, 4.357092], [50.863726, 4.361959], [50.886818, 4.464288], [50.896811, 4.589962], [50.874774, 4.719161], [50.796477, 4.942256], [50.709923, 5.198031], [50.624719, 5.566619] ], 
    					[ [50.845635, 4.357092], [50.835797, 4.335732], [50.774849, 4.276383], [50.729356, 4.231092], [50.697367, 4.047623], [50.626588, 3.782368], [50.605298, 3.626610], [50.612900, 3.399492] ], 
    					[ [50.845635, 4.357092], [50.863726, 4.361959], [50.943827, 4.445703], [50.986208, 4.473984], [51.041311, 4.492129], [51.133022, 4.477598], [51.177464, 4.451833], [51.218123, 4.421339] ], 
    					[ [50.845635, 4.357092], [50.673744, 4.569430], [50.568207, 4.694165], [50.471517, 4.853438], [50.297513, 5.087078], [50.161399, 5.267174], [49.921844, 5.376488], [49.691431, 5.750101] ], 
    					[ [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658], [51.255651, 4.396658] ], 
    					[ [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197], [50.868967, 3.814197] ], 
    					[ [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272], [50.984926, 4.824272] ], 
    					[ [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155], [50.573457, 4.069155] ]  ]

    var wagonContents = [{
		"id": 0,
		"wagon_id": "27 55 1234 5678-9",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 55
	},
	{
		"id": 1,
		"wagon_id": "27 55 2345 6789-0",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 43
	},
	{
		"id": 2,
		"wagon_id": "27 55 3456 7890-1",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 752
	},
	{
		"id": 3,
		"wagon_id": "31 80 4567 8901-2",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 268
	},
	{
		"id": 4,
		"wagon_id": "27 55 1345 6789-0",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 361
	},
	{
		"id": 5,
		"wagon_id": "31 80 1234 5678-9",
		"contents": "Vehicles",
		"status": 0,
		"maintenance": 0
	},
	{
		"id": 6,
		"wagon_id": "32 80 2345 6789-1",
		"contents": "Propane",
		"status": 0,
		"maintenance": 620
	},
	{
		"id": 7,
		"wagon_id": "33 84 3345 6789-1",
		"contents": "Propane",
		"status": 1,
		"maintenance": 50
	},
	{
		"id": 8,
		"wagon_id": "43 87 3345 6789-1",
		"contents": "Benzene",
		"status": 2,
		"maintenance": 92
	}]

	var popupOptions =
        {
        	'maxWidth': '600',
        	'className' : 'wagons'
        }

	function showAllWagons() {
		circles.map(function(wag) {
			//wag.setOpacity(1);
			circleGroup.addLayer(wag);
		});
	}

	function showWagon(wagon) {
		$("#list-elements").append("<div class=\"row-fluid list-element\" id=\"list-element-" + wagon.id + "\">" +
										"<div class=\"col-sm-2 element-badge\">" +
											"<img src=\"img/train-with-badge-green.png\" class=\"train-logo\">" +
										"</div>" +
										"<div class=\"col-sm-10\">" +
											"<div class=\"row-fluid element-id\">" +
												wagon.wagon_id +
											"</div>" +
											"<div class=\"row-fluid short-description\">" +
												wagon.contents + " - Maintenance in " + wagon.maintenance + " days" +
											"</div>" +
										"</div>" +
									  "</div>")
		var rid = wagon.id;
		//circles[rid].setOpacity(1);
		circleGroup.addLayer(circles[rid]);
	}

	$(document).on("mouseover", "[id^=list-element-]", function(){
		$('selector').css( 'cursor', 'pointer' );
	});

	$(document).on("click", "[id^=list-element-]", function() {
		var wagonid = this.id.substring(13);
		var popupCircle = circles[wagonid];
		circleGroup.zoomToShowLayer(popupCircle, function() {
        	popupCircle.openPopup();
    	});
    	// TODO: we should be able to change the class of the list element when it's selected (the trick is to change it back when the user clicks on something else)
    	//this.attr('class', 'list-element active');
	});

	// 1, 6, 20, 50, 100
	function isInTheRightMaintenanceBracket(wagon, maintenanceDays) {
		var wagonMaintenance = wagon.maintenance
		if(maintenanceDays < 1) {
			return true; 
		} else if(maintenanceDays < 2) {
			if(wagonMaintenance > 0 && wagonMaintenance < 6) return true
			else return false;
		} else if(maintenanceDays < 7) {
			if(wagonMaintenance > 5 && wagonMaintenance < 20) return true
			else return false;
		} else if(maintenanceDays < 21) {
			if(wagonMaintenance > 19 && wagonMaintenance < 50) return true
			else return false;
		} else if(maintenanceDays < 51) {
			if(wagonMaintenance > 49 && wagonMaintenance < 100) return true
			else return false;
		} else {
			if(wagonMaintenance > 99) return true
			else return false;
		}
	}

	function populateSearchResults(id, maintenanceDays) {
		if(id === "" && maintenanceDays < 1) {
			showAllWagons()
		} else {

			var relevantWagons = wagonContents.filter(function (wa) {
				return (wa.wagon_id.startsWith(id) && isInTheRightMaintenanceBracket(wa, maintenanceDays) )
			});
			for(i = 0; i < relevantWagons.length; i++) { 
				var currentWagon = relevantWagons[i];
				showWagon(currentWagon)
			}

			// hide irrelevant markers
			var irrelevantWagons = wagonContents.filter(function (wa) {
			  return (!wa.wagon_id.startsWith(id) || !isInTheRightMaintenanceBracket(wa, maintenanceDays) )
			});
			//irrelevantWagons.map(function(wago) {
			//	console.log("irrelevant wagon: " + wago.id)
			//});
			for(j = 0; j < irrelevantWagons.length; j++) {
				var id = irrelevantWagons[j].id
				//circles[id].setOpacity(0)
				circleGroup.removeLayer(circles[id]);
			}

		}
	}

	function passesFilter(id) {
		var filter = $("#id-search").val()
		var maintenanceDays = $("#maintenance-days").val();
		if(wagonContents[id].wagon_id.startsWith(filter) && isInTheRightMaintenanceBracket(wagonContents[id], maintenanceDays)) {
			return true;
		} else {
			return false;
		}
	}

	function applyFilters() {
		var id = $("#id-search").val();
		$("#list-elements").empty();
		var maintenanceDays = $("#maintenance-days").val();

		if(id !== "") {
			$("#empty-space").hide();
			$("#list-space").show();
			populateSearchResults(id, maintenanceDays);
		} else {
			if(maintenanceDays < 1) {
				$("#list-space").hide();
				$("#empty-space").show();
			} else {
				$("#empty-space").hide();
				$("#list-space").show();
			}
			populateSearchResults("", maintenanceDays);
		}
	}

	$(document.body).on('keyup', '#id-search', function(e) {
		applyFilters();
    });

    $(document.body).on('change', '#maintenance-days', function(e) {
		applyFilters();
    });

    //var directions = ['W', 'N', 'N', 'E', 'S'];

	var mymap = L.map('mapid').setView([50.8503, 4.3517], 9); 

	// Mapbox tile (change to something nicer)
	//L.tileLayer('https://api.mapbox.com/styles/v1/vassvdm/ciowq7yly0012dum1tbpfubd1/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmFzc3ZkbSIsImEiOiJjaW93b3F3a3cwMDgydnltMnpyNTF2bmxhIn0.qv9RYZlH6waRMqEsi1Ptfw').addTo(mymap);
	//L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v9.html?title=true&access_token=pk.eyJ1IjoidGF0aWFuYSIsImEiOiJjaWs1bzRiZGQwMDdjcHRrc285bTdwcWU5In0.0EWPVHyjaE9jTzNvOiIO-w#9.03/50.8458/4.4023').addTo(mymap);
	//L.tileLayer('https://api.mapbox.com/styles/v1/vassvdm/cipcxoocf005ycqninsayvfa4/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmFzc3ZkbSIsImEiOiJjaW93b3F3a3cwMDgydnltMnpyNTF2bmxhIn0.qv9RYZlH6waRMqEsi1Ptfw#8/50.83891438521243/4.350211990771214/0').addTo(mymap);

	//var mapBoxUrl = 'https://api.mapbox.com/styles/v1/vassvdm/cipcxoocf005ycqninsayvfa4/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmFzc3ZkbSIsImEiOiJjaW93b3F3a3cwMDgydnltMnpyNTF2bmxhIn0.qv9RYZlH6waRMqEsi1Ptfw';

	//var mapBoxUrl = 'https://api.mapbox.com/styles/v1/pier-re/cipds9e2t006edmm2r5h7r4uw.html?title=true&access_token=pk.eyJ1IjoicGllci1yZSIsImEiOiJRbEo2OXJvIn0.hJMmKuttR_WQOnRnmkowxQ#6.1723966595556785/50.862859289877946/5.046114489549922/0';

	//var mapBoxUrl = 'https://api.mapbox.com/styles/v1/pier-re/cipds9e2t006edmm2r5h7r4uw.html?title=true&access_token=pk.eyJ1IjoidmFzc3ZkbSIsImEiOiJjaW93b3F3a3cwMDgydnltMnpyNTF2bmxhIn0.qv9RYZlH6waRMqEsi1Ptfw';
	var mapBoxUrl = 'https://api.mapbox.com/styles/v1/vassvdm/cipdv2dx7006idmm2m471naku/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidmFzc3ZkbSIsImEiOiJjaW93b3F3a3cwMDgydnltMnpyNTF2bmxhIn0.qv9RYZlH6waRMqEsi1Ptfw';

	var mapboxTiles = L.tileLayer(mapBoxUrl, {
  		//attribution: '&copy; <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  		tileSize: 512,
  		zoomOffset: -1
	});

	mapboxTiles.addTo(mymap);

	//var markersLayer = new L.LayerGroup();	//layer contain searched elements

	var circleGroup = L.markerClusterGroup({
		iconCreateFunction: function (cluster) {
			var markers = cluster.getAllChildMarkers();
			var n = 0;
			for (var i = 0; i < markers.length; i++) {
				if (typeof markers[i].number != 'undefined') {
					n += markers[i].number;
				} else {
					n += 1;
				}
			}
			return L.divIcon({ html: n, className: 'mycluster', iconSize: L.point(40, 40) });
		},
	    spiderfyOnMaxZoom: true,
	    showCoverageOnHover: true,
	    zoomToBoundsOnClick: true
	});

	//var marker = L.marker([50.8356, 4.3357]).addTo(mymap); // 50.8356° N, 4.3357° E
	//marker.bindPopup("<b>Gare du Midi</b><br>Je suis une gare."); //.openPopup();

	var circles = [];

	
	var WagonIcon = L.Icon.extend({
	    options: {
	        iconSize: [26, 32]
	    }
	});

	var greenIcon = new WagonIcon({iconUrl: 'img/green_marker.png'}),
        redIcon = new WagonIcon({iconUrl: 'img/red_marker.png'}),
        orangeIcon = new WagonIcon({iconUrl: 'img/orange_marker.png'});

    function createCircleOtherColor(coordinates, maintenance, color) {
		var newCircle;
		if(color === 'red') {
			newCircle = L.marker(coordinates, {icon: redIcon})
		} else if(color === 'orange') {
			newCircle = L.marker(coordinates, {icon: orangeIcon})
		} else {
			newCircle = L.marker(coordinates, {icon: greenIcon})
		}
		return newCircle;
	}

	function createCircle(coordinates, maintenance) {
		var wcolor = 'green';
		if(maintenance) {
			wcolor = 'red';
		}
		return L.marker(coordinates, {icon: greenIcon})
	}

	function createFullCircleWithCoordinates(coordinates, maintenance, index) {
		var newCircle;
		if(index > 7) {
			var newCircle = createCircleOtherColor(coordinates, maintenance, 'red');
		} else if(index > 5) {
			var newCircle = createCircleOtherColor(coordinates, maintenance, 'orange');
		} else {
			//console.log("green circle " + index)
			var newCircle = createCircle(coordinates, maintenance);
		}
		
		newCircle.bindPopup(populatePopup(wagonContents[index]), popupOptions);
		circleGroup.addLayer(newCircle);
		return newCircle;
	}

	function createFullCircle(number) {
		circles[number] = createCircle(wagons[number], false);
		circles[number].bindPopup(populatePopup(wagonContents[number]), popupOptions);
		circleGroup.addLayer(circles[number]);
		return circles[number];
	}

	function populatePopup(wagon) {
		return "<div class=\"wagon-popup\"> " +
				"	<div class=\"row-fluid popup-header \">" +
				"		<div class=\"col-md-2 train-popup-icon\">" +
				"			<img src=\"img/group-2-blue.png\">" +
				"       </div>" +
				"		<div class=\"col-md-4 id-big\">" +
				"			" + wagon.wagon_id +
				"		</div>" +
				"		<div class=\"col-md-6\">" +
				"		</div>" +
				"	</div>" +
				"	<div class=\"row-fluid popup-body \">" +
				"		<div class=\"col-md-6 metadata\">" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Owner " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					<a href=\"\">Wasco</a> " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Type " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					Tank car " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Cargo " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					Propane " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					&nbsp; " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					&nbsp;" +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid max-speed\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Max speed " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					50 km/h " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Last insp. " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					17 Jan 2013 " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Next insp. " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					16 Jan 2017 (50 days) " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					&nbsp; " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					&nbsp;" +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid position-update\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					GPS fix " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					5 minutes ago " +
				"				</div>" +
				"			</div>" +
				"			<div class=\"row-fluid\">" +
				"				<div class=\"col-md-4 col-md-offset-1 metadata-label\">" +
				"					Registry # " +
				"				</div>" +
				"				<div class=\"col-md-7 metadata-value\">" +
				"					1234 5678 " +
				"				</div>" +
				"			</div>" +
				"       </div>" +
				"		<div class=\"col-md-3 col-md-offset-3 signalisation\">" +
				"			<img src=\"img/railway_signalisation.png\">" +
				"		</div>" +
				"	</div>" +
			   	"</div>"
	}

	/* create all markers, start with moving ones */

	for(i = 0; i < wagons.length; i++) {
		createFullCircle(i, false)
	}

	/* this one will stay at Vrieskaai */
	addMaintenanceWagon();

	function addMaintenanceWagon() {
		circles[5] = createFullCircleWithCoordinates(maintenanceWagon, true, 5);
	} 

	/* Adding a few more stationary icons */
    circles[6] = L.marker([50.868967, 3.814197], {icon: orangeIcon}).addTo(mymap).bindPopup(populatePopup(wagonContents[6]), popupOptions);
	circles[7] = L.marker([50.984926, 4.824272], {icon: orangeIcon}).addTo(mymap).bindPopup(populatePopup(wagonContents[7]), popupOptions);
	circles[8] = L.marker([50.573457, 4.069155], {icon: redIcon}).addTo(mymap).bindPopup(populatePopup(wagonContents[8]), popupOptions);

	circleGroup.addLayer(circles[6]);
	circleGroup.addLayer(circles[7]);
	circleGroup.addLayer(circles[8]);

	mymap.addLayer(circleGroup);

	/**var openrailwaymap = new L.TileLayer('http://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png',
	{
		attribution: '<a href="http://www.openstreetmap.org/copyright">© OpenStreetMap contributors</a>, Style: <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA 2.0</a> <a href="http://www.openrailwaymap.org/">OpenRailwayMap</a> and OpenStreetMap',
		minZoom: 2,
		maxZoom: 19,
		tileSize: 256
	}).addTo(mymap);*/

	//alert("circles: " + circles)
	//alert("circle latlng: " + circles[0].getLatLng().lat)

	/**function updateCoordinates() {
		for(i = 0; i < wagons.length; i++) {
			move(circles[i], directions[i]);
		}
	}

	function move(circle, direction) {
		if(direction === 'N') {
			circle.setLatLng(new L.LatLng(circle.getLatLng().lat + 0.01, circle.getLatLng().lng))
		} else if(direction === 'W') {
			circle.setLatLng(new L.LatLng(circle.getLatLng().lat, circle.getLatLng().lng - 0.01))
		} else if(direction === 'E') {
			circle.setLatLng(new L.LatLng(circle.getLatLng().lat, circle.getLatLng().lng + 0.01))
		} else if(direction === 'S') {
			circle.setLatLng(new L.LatLng(circle.getLatLng().lat - 0.01, circle.getLatLng().lng))
		} else {}
	}*/

	var time = 1;

	function updateCoordinatesItinerary() {
		if(time < 8) {
			circleGroup.clearLayers();
			for(k = 0; k < 9; k++) {
				//mymap.removeLayer(circles[i]);
				moveAlongItinerary(circles[k], k,  itineraries[k], time);
			}
			//addMaintenanceWagon();
			mymap.addLayer(circles);
			time+=1;
		}
	}

	function moveAlongItinerary(circle, index, itinerary, step) {
		
		// we have to remove the circle and add it again to the map to trigger the clustering
		// TODO: this doesn't work very well...
		
		//var elementPos = circles.map(function(x) {return x.id; }).indexOf(circle);
		//console.log("index: " + index);
		//mymap.removeLayer(circle);
		var nextPos = itinerary[step];
		//console.log("nextPos: " + nextPos);
		if(passesFilter(index)) {
			var newCircle = createFullCircleWithCoordinates(nextPos, false, index);
			circles[index] = newCircle;
			//mymap.addLayer(circles[index])
			//console.log("circles[" +  index + "] : " + circles[index]);
			//newCircle.setLatLng(nextPos);
		}
	}

    var millisecondsToWait = 500;
    //var timeCounter = 0;
    //while(timeCounter < 500) {
      window.setInterval(function(){
	    //updateCoordinates()
	    updateCoordinatesItinerary()
	  }, 5000);
    //}
	

</script>
</html>